<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医院挂号系统 - 选择医生和时间</title>
    <!-- 引入Bootstrap样式和图标库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* 页面整体样式 */
        body {
            background-color: #f8f9fa;
            min-height: 100vh;
            padding-bottom: 80px; /* 为底部按钮留出空间 */
        }

        /* 搜索栏样式 */
        .search-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            padding: 1rem 0;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .search-bar .input-group {
            max-width: 600px;
            margin: 0 auto;
        }

        /* 医生卡片样式 */
        .doctor-card {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            margin-bottom: 1rem;
        }

        .doctor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .doctor-card.selected {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

        /* 时间段样式 */
        .time-slots-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-top: 2rem;
        }

        .time-slot {
            cursor: pointer;
            padding: 8px 16px;
            margin: 4px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: inline-block;
            transition: all 0.2s ease;
            background: white;
        }

        .time-slot:hover:not(.unavailable) {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }

        .time-slot.selected {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .time-slot.unavailable {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* 底部导航栏样式 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            padding: 1rem;
            z-index: 1000;
        }

        .bottom-nav .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 日期分组样式 */
        .date-group {
            margin-bottom: 1.5rem;
        }

        .date-group-header {
            font-weight: 500;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        /* 加载动画 */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div id="loading" class="loading" style="display: none;">
        <div class="spinner-border loading-spinner text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <div class="container">
        <!-- 搜索栏 -->
        <div class="search-bar">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text"
                       class="form-control"
                       id="doctor-search"
                       placeholder="搜索医生姓名、科室或职称..."
                       autocomplete="off">
                <button class="btn btn-outline-secondary" type="button" id="clear-search">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>

        <!-- 医生选择区域 -->
        <h4 class="mt-4 mb-3">选择医生</h4>
        <div class="row" id="doctor-list">
            {% for doctor in doctors %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card doctor-card" data-id="{{ doctor.id }}">
                    <div class="card-body">
                        <h5 class="card-title">{{ doctor.name }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">{{ doctor.department }} - {{ doctor.title }}</h6>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- 时间段选择区域 -->
        <div class="time-slots-container">
            <h4 class="mb-3">选择时间段</h4>
            <div id="time-slots">
                {% for slot in time_slots %}
                <div class="time-slot {% if not slot.available %}unavailable{% endif %}"
                     data-id="{{ slot.id }}"
                     {% if not slot.available %}data-unavailable="true"{% endif %}>
                    {{ slot.start_time }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <div class="container">
            <a href="/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回
            </a>
            <button id="confirm-btn" class="btn btn-primary" disabled>
                确认选择 <i class="bi bi-check"></i>
            </button>
        </div>
    </div>

    <!-- Toast提示组件 -->
    <div class="toast-container position-fixed bottom-0 start-50 translate-middle-x p-3">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-info-circle me-2"></i>
                <strong class="me-auto">系统提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <!-- 引入Bootstrap和其他必要的JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let selectedDoctor = null;
        let selectedTimeSlot = null;
        let toast;
        let loading;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化组件
            toast = new bootstrap.Toast(document.getElementById('toast'));
            loading = document.getElementById('loading');

            // 初始化事件监听
            initializeEventListeners();
            initializeTimeSlots();
        });

        // 显示提示信息
        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('toast');
            const iconClass = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle';

            toastEl.querySelector('.bi').className = `bi ${iconClass} me-2`;
            toastEl.querySelector('.toast-body').textContent = message;
            toast.show();
        }

        // 显示/隐藏加载动画
        function toggleLoading(show) {
            loading.style.display = show ? 'flex' : 'none';
        }

        // 初始化事件监听器
        function initializeEventListeners() {
            // 搜索功能
            const searchInput = document.getElementById('doctor-search');
            searchInput.addEventListener('input', debounce(handleSearch, 300));

            // 清除搜索
            document.getElementById('clear-search').addEventListener('click', () => {
                searchInput.value = '';
                handleSearch({ target: { value: '' } });
            });

            // 医生选择
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.addEventListener('click', () => {
                    const doctorId = card.dataset.id;
                    selectDoctor(doctorId);
                });
            });

            // 确认按钮
            document.getElementById('confirm-btn').addEventListener('click', handleConfirm);
        }

        // 初始化时间段选择
        function initializeTimeSlots() {
            document.querySelectorAll('.time-slot:not(.unavailable)').forEach(slot => {
                slot.addEventListener('click', () => {
                    if (slot.classList.contains('unavailable')) return;

                    document.querySelectorAll('.time-slot').forEach(s => {
                        s.classList.remove('selected');
                    });
                    slot.classList.add('selected');
                    selectedTimeSlot = {
                        id: slot.dataset.id,
                        start_time: slot.textContent.trim()
                    };
                    updateConfirmButton();
                });
            });
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 处理搜索
        async function handleSearch(event) {
            const keyword = event.target.value;
            toggleLoading(true);

            try {
                const response = await fetch(`/api/doctors?keyword=${encodeURIComponent(keyword)}`);
                const doctors = await response.json();

                const doctorList = document.getElementById('doctor-list');
                doctorList.innerHTML = doctors.map(doctor => `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card doctor-card ${selectedDoctor && selectedDoctor.id === doctor.id ? 'selected' : ''}"
                             data-id="${doctor.id}"
                             onclick="selectDoctor('${doctor.id}')">
                            <div class="card-body">
                                <h5 class="card-title">${doctor.name}</h5>
                                <h6 class="card-subtitle mb-2 text-muted">${doctor.department} - ${doctor.title}</h6>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('搜索医生失败:', error);
                showToast('搜索医生失败，请重试', 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // 选择医生
        function selectDoctor(doctorId) {
            selectedDoctor = {
                id: doctorId
            };

            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.id === doctorId);
            });

            updateConfirmButton();
        }

        // 更新确认按钮状态
        function updateConfirmButton() {
            const confirmBtn = document.getElementById('confirm-btn');
            confirmBtn.disabled = !selectedDoctor || !selectedTimeSlot;
        }

        // 处理确认选择
        async function handleConfirm() {
            if (!selectedDoctor || !selectedTimeSlot) {
                showToast('请选择医生和时间段', 'error');
                return;
            }

            toggleLoading(true);

            try {
                const response = await fetch('/api/add_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        doctor_id: selectedDoctor.id,
                        time_slot_id: selectedTimeSlot.id
                    })
                });

                const data = await response.json();
                if (data.success) {
                    window.location.href = '/';
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('添加任务失败:', error);
                showToast('添加任务失败，请重试', 'error');
            } finally {
                toggleLoading(false);
            }
        }
    </script>
</body>
</html>